================================================================================
IMPLEMENTATION CHECKLIST: Pre-Entry Filter Auto-Learning
================================================================================

## Overview

Make the auto pattern generator (`create_new_paterns.py`) learn optimal pre-entry
thresholds from historical data, so it can dynamically adjust the 0.08% → 0.20%
threshold based on recent trade performance.

## Prerequisites

✅ Pre-entry columns exist in buyin_trail_minutes (they do - checked earlier)
✅ pre_entry_price_movement.py module exists and works
✅ pattern_validator.py has pre-entry check (lines 1154-1203)
✅ Investigation complete with recommended thresholds

## Implementation Tasks

### Phase 1: Update Pattern Generator (2-3 hours)

File: `000data_feeds/7_create_new_patterns/create_new_paterns.py`

- [ ] **Task 1.1**: Add pre-entry columns to `load_trade_data()`
  - Location: ~line 198
  - Add: pre_entry_change_3m, pre_entry_change_1m, entry_buy_pressure
  - JOIN with buyin_trail_minutes WHERE minute=0 AND sub_minute=0

- [ ] **Task 1.2**: Create `analyze_pre_entry_thresholds()` function
  - Location: After `analyze_filter_ranges()` (~line 800)
  - Logic: Find minimum change_3m that keeps 70%+ good, removes 30%+ bad
  - Return: Dict with suggested thresholds

- [ ] **Task 1.3**: Update `sync_best_filters_to_project()`
  - Location: ~line 1311
  - Add parameter: `pre_entry_suggestions`
  - Insert pre-entry filters with section='pre_entry'
  - Use special ID range: 90000 + project_id

- [ ] **Task 1.4**: Call pre-entry analysis in `generate_auto_filters_main()`
  - Location: ~line 1850 (in Step 3)
  - Call: `pre_entry_suggestions = analyze_pre_entry_thresholds(df, threshold)`
  - Pass to sync function

### Phase 2: Update Pattern Validator (1 hour)

File: `000trading/pattern_validator.py`

- [ ] **Task 2.1**: Add dynamic threshold lookup
  - Location: Lines 1154-1203 (pre-entry check)
  - Before calling `should_enter_based_on_price_movement()`
  - Query pattern_config_filters for section='pre_entry'
  - Use learned threshold or fallback to 0.20 (not 0.08!)

- [ ] **Task 2.2**: Update default threshold
  - Location: Line 168 in `pre_entry_price_movement.py`
  - Change: `min_change_3m: float = 0.08` → `0.20`
  - This ensures safe default when no learned threshold exists

### Phase 3: Testing (1-2 hours)

- [ ] **Task 3.1**: Create test script
  - File: `wallet_analysis/test_auto_pre_entry.py`
  - Check if pre-entry filters exist in database
  - Verify trail data has pre-entry columns

- [ ] **Task 3.2**: Test pattern generation
  - Run: `python3 000data_feeds/7_create_new_patterns/create_new_paterns.py`
  - Verify pre-entry filters created in pattern_config_filters
  - Check threshold values are reasonable (0.15-0.25% range)

- [ ] **Task 3.3**: Test validation
  - Run: `python3 wallet_analysis/test_improved_filter.py 20260203184619631`
  - Verify it uses learned threshold (if exists)
  - Verify it falls back to 0.20% (if no learned threshold)

- [ ] **Task 3.4**: Test on training mode
  - Enable training in play settings
  - Run 10-20 synthetic trades
  - Verify pre-entry filters work correctly

### Phase 4: Deployment (30 mins)

- [ ] **Task 4.1**: Deploy pattern generator changes
  - Restart: `scheduler/run_component.py --component create_new_patterns`
  - Monitor logs for errors

- [ ] **Task 4.2**: Wait for pattern generation cycle
  - Runs every 10 minutes (default)
  - Check pattern_config_filters table after run

- [ ] **Task 4.3**: Verify filters applied to plays
  - Check plays with pattern_update_by_ai=1
  - Verify project_ids includes auto-filters project

- [ ] **Task 4.4**: Monitor rejection rate
  - Track trades rejected by pre-entry filter
  - Compare before/after metrics

## Quick Reference Commands

```bash
# Test if pre-entry data exists
psql -U postgres -d postgres -c "
SELECT COUNT(*) FROM buyin_trail_minutes 
WHERE pre_entry_change_3m IS NOT NULL"

# Check for pre-entry filters in project 5
psql -U postgres -d postgres -c "
SELECT * FROM pattern_config_filters 
WHERE project_id = 5 AND section = 'pre_entry'"

# Run pattern generator manually
cd /root/follow_the_goat
python3 000data_feeds/7_create_new_patterns/create_new_paterns.py

# Test improved filter
python3 wallet_analysis/test_improved_filter.py 20260203184619631

# Test auto integration
python3 wallet_analysis/test_auto_pre_entry.py

# Monitor pattern generator logs
tail -f scheduler/logs/create_new_patterns.log
```

## Success Criteria

✅ Pre-entry filters appear in pattern_config_filters table
✅ Learned threshold is reasonable (0.15-0.30% range)
✅ pattern_validator uses learned threshold
✅ Falls back to 0.20% if no learned threshold
✅ Trade 20260203184619631 would be rejected
✅ Rejection rate increases by 20-30%
✅ Good trades still pass through (70%+ retention)

## Rollback Plan

If something goes wrong:

1. **Disable auto filters**: Set pattern_update_by_ai=0 on affected plays
2. **Clear bad filters**: `DELETE FROM pattern_config_filters WHERE section='pre_entry'`
3. **Revert code**: Git revert changes to create_new_paterns.py
4. **Restart scheduler**: Restart pattern generator component

## Timeline

- **Phase 1**: 2-3 hours (pattern generator changes)
- **Phase 2**: 1 hour (validator changes)
- **Phase 3**: 1-2 hours (testing)
- **Phase 4**: 30 mins (deployment)

**Total**: 4-6 hours for complete implementation

## Files to Modify

1. `000data_feeds/7_create_new_patterns/create_new_paterns.py`
2. `000trading/pattern_validator.py`
3. `000trading/pre_entry_price_movement.py` (default threshold only)

## Files Created (Investigation)

- wallet_analysis/PRE_ENTRY_AUTO_INTEGRATION_GUIDE.txt (full guide)
- wallet_analysis/IMPLEMENTATION_CHECKLIST.txt (this file)
- wallet_analysis/test_auto_pre_entry.py (test script - to create)

## Next Steps

1. Read PRE_ENTRY_AUTO_INTEGRATION_GUIDE.txt for detailed code
2. Start with Phase 1 Task 1.1 (add pre-entry columns to load function)
3. Test each phase before moving to next
4. Monitor closely during deployment

================================================================================
Status: READY TO IMPLEMENT
Estimated Time: 4-6 hours
Risk Level: LOW (fallback to safe default if anything fails)
================================================================================
